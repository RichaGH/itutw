# Вопрос
You are an IT engineer with 20 years of experience. You need to upgrade Centos 8 Stream to almalinux 9.5. You have already upgraded to Alt linux 8.10, but in the process of upgrading to almalinux9.5, leap issues errors in the report file. you need to figure out the errors. Also, explain to the young colleague the meaning of the commands you enter and the results of their execution.

# Рассуждения
We are in a scenario where we have upgraded from CentOS 8 Stream to Alt Linux 8.10, and now we are trying to upgrade to AlmaLinux 9.5 but encountering errors.

Since the error report is not provided, I'll outline a general approach to diagnose and resolve common upgrade issues. Additionally, I'll explain each command and its output to a junior colleague.

Steps:

1. Check the system's current state and the error logs.

2. Analyze the leap errors (likely from the Leapp tool used for in-place upgrades).

3. Resolve the issues and then re-run the upgrade process.

Let's break it down:

Step 1: Check the current OS version and the Leapp logs.

Command:

`cat /etc/os-release`

Explanation:

This command displays the operating system identification data. After the upgrade to Alt Linux 8.10, we expect to see Alt Linux 8.10.

Command:

`leapp upgrade`

Explanation:

We run this command to start the upgrade process to AlmaLinux 9. However, if it fails, we need to check the report.

Command (if leapp fails):

`leapp preupgrade`   # This is actually the first step to run for pre-upgrade checks.

But note: The upgrade process to AlmaLinux 9 using Leapp typically involves:

- `leapp preupgrade` to run pre-upgrade checks and generate a report.

- Then `leapp upgrade` to perform the upgrade.

Since we encountered errors, we should look at the report generated by `leapp preupgrade`.

Step 2: Locate and analyze the Leapp report.

The report is usually located at:

`/var/log/leapp/leapp-report.json` or `/var/log/leapp/leapp-report.txt`

We can view the report with:

`cat /var/log/leapp/leapp-report.txt`

Or if we prefer a JSON format (if available) we can use `jq` to parse it, but let's stick to the text version for simplicity.

If the report is too long, we can use `grep` to search for keywords like 'ERROR', 'FAIL', or 'Inhibitor'.

Command:

`grep -iE 'ERROR|FAIL|Inhibitor' /var/log/leapp/leapp-report.txt`

Explanation:

- `grep`: a text search tool.

- `-i`: ignore case.

- `-E`: use extended regular expressions (so we can use '|' for OR).

- This command will show lines that have the words ERROR, FAIL, or Inhibitor (case insensitive).

Step 3: Common issues and resolutions.

Common inhibitors during an upgrade from EL8 to EL9:

a. Unsupported third-party repositories.

b. Unsupported or obsolete packages.

c. Missing kernel modules or drivers.

d. Configuration files that will be overwritten.

Let's address each:

a. Disable or remove any third-party repositories (like EPEL, or custom ones) that are not yet compatible with EL9.

Command to list repositories:

`dnf repolist`

Command to disable a repository (for example, epel):

`dnf config-manager --set-disabled epel`

Or to remove a repository:

`rm /etc/yum.repos.d/<repo_file>.repo`

b. Remove obsolete packages. Leapp might flag packages that are no longer available in EL9 or that conflict. The report usually suggests which packages to remove.

Example command to remove a package:

`dnf remove <package_name>`

c. For missing kernel modules, we might need to ensure that all necessary drivers are available. However, Leapp usually handles this by including a special kernel for the upgrade.

d. Configuration file changes: Leapp might detect configuration files that have been modified and are about to be overwritten. We can either back them up and then accept the new version, or manually merge changes.

Step 4: After resolving the issues, re-run the pre-upgrade:

`leapp preupgrade`

Then check the report again to ensure no inhibitors remain.

Step 5: If the pre-upgrade report is clean, run the upgrade:

`leapp upgrade`

This will reboot the system and perform the upgrade.

Step 6: After the upgrade, verify:

`cat /etc/os-release`  # should show AlmaLinux 9.5

`uname -r`             # should show a new kernel version

Additional note: Since we are upgrading from Alt Linux 8.10 (which is based on RHEL 8) to AlmaLinux 9.5 (based on RHEL 9), it's important to note that Alt Linux is not the same as CentOS. However, the Leapp tool is designed for RHEL-derived distributions. We must ensure that we are using the correct Leapp data and upgrade paths for AlmaLinux.

For AlmaLinux, we use the `leapp-upgrade` package from the AlmaLinux repositories and the `leapp-data-almalinux` package.

Let's make sure we have the necessary packages:

- `leapp-upgrade-el9toel10` (but note: we are going from EL8 to EL9, so we need the `el8toel9` package)

- `leapp-data-almalinux`

We should have installed these before starting the upgrade.

If we haven't, we can set them up:

Add the AlmaLinux Leapp repository for EL8 (since we are on Alt Linux 8.10, which is EL8 compatible):

Create a repo file: `/etc/yum.repos.d/almalinux-leapp.repo`

Content:

[almalinux-leapp]

name=AlmaLinux Leapp

baseurl=https://repo.almalinux.org/almalinux/leapp/el8/$basearch/

enabled=1

gpgcheck=1

gpgkey=https://repo.almalinux.org/almalinux/RPM-GPG-KEY-AlmaLinux

Then install the packages:

`dnf install leapp-upgrade leapp-data-almalinux`

Note: The package `leapp-upgrade` for AlmaLinux 8 to 9 might be named differently, so check the repository. It might be in the `leapp-upgrade-el8toel9` package.

Actually, the package names as of now are:

- `leapp-upgrade` (this is the main leapp upgrade tool)

- `leapp-data-almalinux` (this contains the AlmaLinux specific data)

We might also need to install the `leapp` tool itself if not already installed.

Since we were able to run `leapp preupgrade`, we likely have leapp installed.

But we must ensure we have the AlmaLinux data and the correct upgrade path.

Also, note that the Alt Linux might have some differences. We might need to adjust the repositories to point to AlmaLinux 8 and then upgrade to 9.

However, the standard approach is:

- Remove all non-AlmaLinux repositories.

- Ensure the system is updated to the latest Alt Linux 8.10 (which should be binary compatible with RHEL 8.10?).

But note: Alt Linux is not RHEL, so there might be incompatibilities.

Alternatively, if we are facing too many issues, a clean installation of AlmaLinux 9 might be considered.

Given the complexity, let's focus on the Leapp errors and try to resolve them.

Example Error Resolution:

If the report says: "The following obsolete packages are installed: packageX"

Then remove them: `dnf remove packageX`

If the report says: "There are enabled repositories that are not signed by the distribution: repoX"

Then disable that repository.

If the report says: "Module X is not supported in the target system"

Then we might need to remove the module or the package that provides it.

If the report says: "The following installed packages are not available in target system: packageY"

Then remove packageY.

If the report says: "The system is registered to Red Hat Subscription Management. This tool is not available in the target system."

Since we are moving to AlmaLinux (which doesn't use RHN), we need to remove the subscription-manager package.

`dnf remove subscription-manager`

If the report says: "Found 1 inhibitor(s)."

We must resolve each inhibitor.

After each fix, run `leapp preupgrade` again until the report is clean.

Finally, proceed with `leapp upgrade`.

Remember: The upgrade process is complex and might break. Always have a backup.

Let me know if you have specific errors from the report to dive deeper.

Diagnosing and Resolving AlmaLinux 9.5 Upgrade Errors
You've encountered errors during the leapp pre-upgrade phase (from ALT Linux 8.10 to AlmaLinux 9.5). Let's systematically troubleshoot this. Below, I'll explain each command and its purpose to help you understand the process.

# Ответ


### Diagnosing and Resolving AlmaLinux 9.5 Upgrade Errors  
You've encountered errors during the `leapp` pre-upgrade phase (from ALT Linux 8.10 to AlmaLinux 9.5). Let's systematically troubleshoot this. Below, I'll explain each command and its purpose to help you understand the process.

---

#### **Step 1: Review Leapp Pre-Upgrade Report**  
The `leapp` tool generates a report at `/var/log/leapp/leapp-report.txt`. This file details inhibitors (blockers) causing the upgrade to fail.  

**Command:**  
```bash
sudo less /var/log/leapp/leapp-report.txt
```  
- **Why?**  
  `less` allows paginated viewing of large files. Search for `Inhibitor` or `ERROR` sections (press `/` + `Inhibitor` + `Enter`).  
- **Expected Output:**  
  You'll see entries like:  
  ```  
  Risk Factor: high (inhibitor)  
  Title: Unsupported third-party repositories  
  Summary: Repositories not signed by AlmaLinux/RHEL detected.  
  ```  

---

#### **Step 2: Identify Blockers**  
Common issues include:  
1. **Unsupported repositories** (non-AlmaLinux repos).  
2. **Obsolete packages** (packages not available in EL9).  
3. **Kernel drivers** (missing/incompatible).  
4. **Configuration conflicts** (e.g., `sudo`, `grub`).  

**Command to List Repositories:**  
```bash
sudo dnf repolist --all
```  
- **Why?**  
  `dnf repolist` shows enabled repositories. ALMA Linux 9 requires AlmaLinux-signed repos. Disable non-compliant repos (e.g., EPEL, custom RPMs).  
- **Fix:**  
  ```bash
  sudo dnf config-manager --disable <unsupported-repo-id>  # Disable bad repos
  sudo rm /etc/yum.repos.d/<problem-repo>.repo             # Delete if necessary
  ```

---

#### **Step 3: Check for Problematic Packages**  
**Command:**  
```bash
sudo leapp preupgrade  # Re-run pre-upgrade to refresh logs
sudo grep -E 'remove|inhibitor' /var/log/leapp/leapp-report.txt
```  
- **Why?**  
  Identifies packages that must be removed before upgrading (e.g., deprecated kernel modules).  
- **Example Output:**  
  ```  
  Package <bad-package> is not supported in AlmaLinux 9.5. Remove it.  
  ```  
- **Fix:**  
  ```bash
  sudo dnf remove <bad-package>
  ```

---

#### **Step 4: Inspect System Drivers**  
**Command:**  
```bash
sudo grep -i 'driver' /var/log/leapp/leapp-report.txt
```  
- **Why?**  
  Missing kernel drivers (e.g., storage, network) can block upgrades. Leapp may require updated drivers for EL9.  
- **Fix:**  
  Install AlmaLinux 9-compatible drivers:  
  ```bash
  sudo dnf install kmod-<driver-name>  # Replace with actual driver name
  ```

---

#### **Step 5: Validate System Configuration**  
**Command:**  
```bash
sudo leapp verify --no-rhsm  # Skip subscription checks (not needed for AlmaLinux)
```  
- **Why?**  
  Checks for config file conflicts (e.g., `/etc/sudoers`, `/etc/grub.conf`).  
- **Output:**  
  ```  
  Verify finished. Check /var/log/leapp/leapp-verify.log  
  ```  
- **Fix:**  
  Manually resolve conflicts flagged in the log. Backup files first:  
  ```bash
  sudo cp /etc/sudoers /etc/sudoers.bak
  ```

---

#### **Step 6: Re-run Pre-Upgrade**  
After fixes, re-run:  
```bash
sudo leapp preupgrade --force  # Force re-check
```  
- **Why `--force`?**  
  Overrides previous results (uses updated system state).  
- **Success Criteria:**  
  Final report (`/var/log/leapp/leapp-report.txt`) should show **no inhibitors**.  

---

#### **Step 7: Execute the Upgrade**  
If pre-upgrade succeeds:  
```bash
sudo leapp upgrade
```  
- **What Happens?**  
  1. Leapp downloads AlmaLinux 9.5 packages.  
  2. Reboots into a temporary environment to apply changes.  
  3. Finalizes the upgrade post-reboot.  

---

### **Key Takeaways for Junior Engineers**  
1. **Leapp Reports Are Crucial**  
   - Always check `/var/log/leapp/leapp-report.txt` first. Inhibitors halt upgrades.  
2. **Repositories Matter**  
   - AlmaLinux requires signed repos. Remove third-party repos unless explicitly compatible.  
3. **Clean Package State**  
   - Remove obsolete packages early to avoid conflicts.  
4. **Force Flag**  
   - Use `leapp preupgrade --force` after fixes to reset the tool’s state.  
5. **Backups Save Lives**  
   - Always backup config files (`/etc`) before major upgrades.  

### **Next Steps**  
- If errors persist, share excerpts from:  
  ```bash
  sudo cat /var/log/leapp/leapp-report.txt | grep -A 10 'Inhibitor'
  ```  
- **Pro Tip:** Test the upgrade in a VM first if possible!  

Let me know what the report reveals—we’ll tackle it together! ????

